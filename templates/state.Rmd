---
params:
  area: ""
title: ""
date: "`r Sys.Date()`"
output:
  blogdown::html_page:
    toc: true
---

```{r setup, include=FALSE, out.width="100%"}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(leaflet)
library(sf)

# Parameters
  # Parameters for state and data
file_data_params <- here::here("data/params.yml")
  # Household Pulse data for state
file_hps <- here::here("data/state.csv")
  # Population data
file_population <- here::here("data/population.csv")
  # Unemployment data
file_unemployment <- here::here("data/unemployment.csv")
  # Food insufficiency estimates for counties
file_counties <- here::here("data/counties.csv")
  # Number of bins for maps  
N_BINS <- 5
  # Map color palette
MAP_COLOR_PALETTE <- "YlOrRd"
  # Map height
MAP_HEIGHT <- 650
  # Age group breaks
AGE_BREAKS <- c(18, seq(29, 79, 10), Inf)
  # Age group labels
AGE_LABELS <- 
  c("18 - 29", str_c(seq(30, 70, 10), " - ", seq(39, 79, 10)), "80+")

#===============================================================================

# Parameters for state and data
data_params <- yaml::read_yaml(file_data_params)

# Population data for counties
population <- 
  read_csv(file_population) %>% 
  filter(area_type == "County")

# Household Pulse data for state
hps <- 
  read_csv(file_hps) %>% 
  filter(area_type == "State")

# Last dates for Household Pulse data
hps_date_start <- max(hps$date_start)
hps_date_end <- max(hps$date_end)

# Last date for Household Pulse PUF data
hps_puf_date_end <- 
  hps %>% 
  drop_na(n_error) %>% 
  pull(date_end) %>% 
  max()

# Unemployment data
unemployment <- read_csv(file_unemployment)

# Food insufficiency estimates for county
counties <- read_csv(file_counties)

# County boundaries for map
county_boundaries <-
  ussf::boundaries(
    geography = "county",
    resolution = "5m",
    projection = "longlat"
  ) %>% 
  filter(STATEFP == data_params$state_fips)

#===============================================================================

# Month of date
month <- function(date) {
  format(date, "%B")
}

# Month and day of date
month_day <- function(date) {
  format(date, "%B %e") %>%
    str_replace("  ", " ")
}

# Choropleth map
choropleth <- function(data, var, population, tooltip, legend_title) {
  
  values <- 
    data %>% 
    pull({{var}})
    
  bins <-
    Hmisc::wtd.quantile(
      values,
      weights = data %>% pull({{population}}),
      probs = seq(0, 1, length.out = N_BINS + 1)
    )
  
  values[near(values, min(bins))] <- min(bins)
  values[near(values, max(bins))] <- max(bins)

  fill_color <- 
    colorBin(
      palette = MAP_COLOR_PALETTE,
      domain = values,
      bins = bins
    )
  
  tooltips <-
    data %>% 
    str_glue_data(tooltip) %>% 
    map(htmltools::HTML)
  
  data %>%
    leaflet(height = MAP_HEIGHT) %>%
    addProviderTiles(
      provider = "MapBox",
      options =
        providerTileOptions(
          id = "mapbox.light",
          accessToken = Sys.getenv("MAPBOX_ACCESS_TOKEN")
        )
    ) %>%
    addPolygons(
      color = "black",
      weight = 0.2,
      opacity = 1,
      fillColor = ~ fill_color(values),
      fillOpacity = 1,
      label = tooltips,
      labelOptions =
        labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto"
        ),
      highlightOptions =
        highlightOptions(
          color = "black",
          weight = 1.5,
          bringToFront = TRUE
        )
    ) %>%
    addLegend(
      position = "topright",
      pal = fill_color,
      values = values,
      opacity = 1,
      labFormat = labelFormat(suffix = "%"),
      title = legend_title
    )
}
```

## Overview

The data on this site is derived from the U.S. Census Bureau [Household Pulse Survey (HPS)](https://www.census.gov/householdpulsedata) and the U.S. Bureau of Labor Statistics [Local Area Unemployment Statistics (LAUS)](https://www.bls.gov/lau/home.htm). New HPS data is released once a week, and new LAUS data is released once a month. The most recent data used for this report are:

* Household Pulse Survey: `r month_day(hps_date_start)` - `r month_day(hps_date_end)`
* Local Area Unemployment Statistics: `r month(max(unemployment$date))`

The HPS releases data in two stages. For this reason, some time series below run through `r month_day(hps_puf_date_end)`, while others run through `r month_day(hps_date_end)`.

This report updates upon the release of new data. Sign up with [this form](https://forms.gle/MssCSstca6egwMDF6) to be notified of updates. All data used in this report can be found and downloaded [here](https://github.com/stanford-datalab/covid-19-ca/tree/master/data). All code used to download and process the raw data and to generate this site can be found [here](https://github.com/stanford-datalab/covid-19-ca).

If you have any feedback, comments, or suggestions for improvements to this site, please [email us](mailto:datalab@stanford.edu).

## Food insufficiency

### Rate over time

The plot below contains the percentage of adults who answered this question:

>  In the __last 7 days__, which of these statements best describes the food eaten in your household?

with one of these two answers:

> Sometimes not enough to eat  
> Often not enough to eat

```{r}
prior_food_insufficiency <- 
  hps %>%
  filter(variable == "prifoodsuf", code %in% 3:4) %>% 
  group_by(date_end) %>% 
  summarize(prior_food_insufficiency = sum(pct)) %>% 
  pull(prior_food_insufficiency) %>% 
  mean()

v <- 
  hps %>% 
  group_by(date_end) %>% 
  summarize(
    n = sum(n[variable == "curfoodsuf" & code %in% 3:4]),
    pct = sum(pct[variable == "curfoodsuf" & code %in% 3:4])
  )

v %>% 
  ggplot(aes(date_end, pct)) +
  geom_hline(yintercept = prior_food_insufficiency, color = "blue") +
  geom_line() +
  geom_point() +
  annotate(
    geom = "text",
    x = min(v$date_end),
    y = prior_food_insufficiency,
    label = "Food insufficiency prior to Mar 13",
    hjust = 0,
    vjust = 1.5
  ) +
  scale_x_date(
    breaks = v$date_end,
    minor_breaks = NULL,
    date_labels = "%b %e"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(1),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  labs(
    title = "Food insufficiency during the prior 7 days",
    x = "Survey end date",
    y = "Percentage of adults reporting food insufficiency",
    caption = "Source: Census Bureau, Household Pulse Survey."
  )

v <- 
  v %>% 
  filter(date_end == max(date_end))
```

In the most recent survey period that ended `r month_day(v$date_end)`, an estimated `r format(round(v$pct, digits = 1))`% of `r params$area` adults, or approximately `r format(signif(v$n, digits = 3), big.mark = ",")` adults, lived in households with food insufficiency.

The HPS was not designed to measure food insufficiency in children, but other surveys typically find food insufficiency rates among children to be substantially higher than among adults.

### Geography

The map below is for the survey period that ended `r month_day(hps_date_end)`. Hover over counties for rates.

```{r}
v <- 
  left_join(
    county_boundaries,
    counties %>% 
      filter(date_end == max(date_end)) %>% 
      group_by(area, fips, date_end, variable) %>% 
      summarize(food_insufficiency = sum(pct)) %>% 
      ungroup() %>% 
      left_join(population %>% select(fips, population_18p), by = "fips"),
    by = c("GEOID" = "fips")
  )

v %>% 
  choropleth(
    var = food_insufficiency,
    population = population_18p,
    tooltip = 
      "<strong>{area}</strong><br/>Food insufficiency: {format(food_insufficiency, trim = TRUE, nsmall = 1)}%",
    legend_title = "Food insufficiency<br/>in adults"
  )
```

Estimated from: Census Bureau, Household Pulse Survey.  
Bureau of Labor Statistics, Local Area Unemployment Statistics.

These food insufficiency estimates for `r data_params$state`'s counties are based upon a model. The model uses the food insufficiency rate for the entire state and the county unemployment rates to estimate food insufficiency for each county. 

County unemployment rates are updated every month, but state-level food insufficiency is updated every week. Each month's unemployment data also comes out later than the food insufficiency data. For months where unemployment data is not yet available, the model uses the latest month for which data is available.

### Demographics

```{r}
v <- 
  hps %>% 
  filter(
    date_end == hps_puf_date_end,
    str_detect(variable, "^tbirth_year")
  ) %>% 
  mutate(
    age = lubridate::year(lubridate::now()) - code,
    age_group = 
      cut(
        age, 
        breaks = AGE_BREAKS,
        labels = AGE_LABELS,
        include.lowest = TRUE
      )
  ) %>% 
  group_by(age_group, variable) %>% 
  summarize(n = sum(n)) %>% 
  ungroup()

overall_rate <- 
  v %>% 
  summarize(
    pct = 
      100 * sum(n[variable == "tbirth_year_curfoodsuf_34"]) / 
      sum(n[variable == "tbirth_year"]),
    label = "Overall food insufficiency rate"
  )

v <- 
  v %>% 
  group_by(age_group) %>% 
  summarize(
    pct =
      100 * n[variable == "tbirth_year_curfoodsuf_34"] / 
      n[variable == "tbirth_year"]
  )

v %>% 
  ggplot(aes(age_group, pct)) +
  geom_hline(aes(yintercept = pct, color = label), data = overall_rate) +
  geom_col() +
  scale_y_continuous(
    breaks = scales::breaks_width(2),
    labels = scales::label_percent(accuracy = 1, scale = 1)
  ) +
  theme(legend.position = "bottom") +
  labs(
    title = "Food insufficiency by age group",
    subtitle = 
      str_glue("For the survey period that ended {month_day(hps_puf_date_end)}"),
    x = "Age group",
    y = "Percentage of age group reporting food insufficiency",
    color = NULL,
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

<br>
<br>

```{r}
v <- 
  hps %>% 
  filter(
    date_end == hps_puf_date_end,
    str_detect(variable, "^egender")
  ) 

overall_rate <- 
  v %>% 
  summarize(
    pct = 
      100 * sum(n[variable == "egender_curfoodsuf_34"]) / 
      sum(n[variable == "egender"]),
    label = "Overall food insufficiency rate"
  )

v <- 
  v %>% 
  group_by(response) %>% 
  summarize(
    pct =
      100 * n[variable == "egender_curfoodsuf_34"] / 
      n[variable == "egender"]
  )

v %>% 
  ggplot(aes(response, pct)) +
  geom_hline(aes(yintercept = pct, color = label), data = overall_rate) +
  geom_col() +
  scale_y_continuous(
    breaks = scales::breaks_width(2),
    labels = scales::label_percent(accuracy = 1, scale = 1)
  ) +
  theme(legend.position = "bottom") +
  labs(
    title = "Food insufficiency by gender",
    subtitle = 
      str_glue("For the survey period that ended {month_day(hps_puf_date_end)}"),
    x = NULL,
    y = "Percentage of gender reporting food insufficiency",
    color = NULL,
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

<br>
<br>

```{r}
v <- 
  hps %>% 
  filter(
    date_end == hps_puf_date_end,
    str_detect(variable, "^rhispanic_rrace")
  ) %>% 
  mutate(
    response =
      case_when(
        str_detect(response, "^Hispanic") ~ "Hispanic",
        TRUE ~ response
      )
  ) %>% 
  group_by(variable, response) %>% 
  summarize(n = sum(n)) %>% 
  ungroup()

overall_rate <- 
  v %>% 
  summarize(
    pct = 
      100 * sum(n[variable == "rhispanic_rrace_curfoodsuf_34"]) / 
      sum(n[variable == "rhispanic_rrace"]),
    label = "Overall food insufficiency rate"
  )

v <- 
  v %>% 
  group_by(response) %>% 
  summarize(
    pct =
      100 * n[variable == "rhispanic_rrace_curfoodsuf_34"] / 
      n[variable == "rhispanic_rrace"]
  )

v %>% 
  ggplot(aes(fct_reorder(response, pct), pct)) +
  geom_hline(aes(yintercept = pct, color = label), data = overall_rate) +
  geom_col() +
  scale_y_continuous(
    breaks = scales::breaks_width(2),
    labels = scales::label_percent(accuracy = 1, scale = 1)
  ) +
  theme(legend.position = "bottom") +
  labs(
    title = "Food insufficiency by race and ethnicity",
    subtitle = 
      str_glue("For the survey period that ended {month_day(hps_puf_date_end)}"),
    x = NULL,
    y = "Percentage of group reporting food insufficiency",
    color = NULL,
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

In the above, _Hispanic_ refers to individuals of any race. _White_, _Black_, and _Asian_ refer to individuals of that single race. And _Other_ refers to individuals of two or more races, or races other the White, Black, or Asian.

### Reasons

```{r fig.asp=0.8}
v <- 
  hps %>% 
  filter(str_detect(variable, "^foodsufrsn\\d_curfoodsuf_34$"), !is.na(code))

v %>% 
  ggplot(aes(date_end, pct, color = fct_reorder2(response, date_end, pct))) +
    geom_line() +
  geom_point() +
  scale_x_date(
    breaks = v$date_end %>% unique() %>% sort(),
    minor_breaks = NULL,
    date_labels = "%b %e"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(10),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  guides(color = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom") +
  labs(
    title = "Reasons for food insufficiency in adults",
    x = "Survey end date",
    y = "",
    color = NULL,
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

The above plot contains the reasons respondents gave for selecting "Sometimes not enough to eat" or "Often not enough to eat". Respondents can choose more than one reason, so the percentages sum to greater than 100%.

### Severity

```{r}
v <- 
  hps %>% 
  filter(variable == "curfoodsuf", code %in% 3:4) %>% 
  group_by(date_end) %>% 
  mutate(prop = n / sum(n))

v %>% 
  ggplot(aes(date_end, prop, color = fct_inorder(response))) +
  geom_line() +
  geom_point() +
  scale_x_date(
    breaks = v$date_end %>% unique() %>% sort(),
    minor_breaks = NULL,
    date_labels = "%b %e"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(0.1),
    labels = scales::label_percent(accuracy = 1),
    limits = c(0, NA)
  ) +
  scale_color_discrete(direction = -1) +
  theme(legend.position = "bottom") +
  labs(
    title = "Type of food insufficiency in adults",
    x = "Survey end date",
    y = "Percentage of type of food insufficiency",
    color = NULL,
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

### Free groceries or meals

```{r}
v <- 
  hps %>% 
  filter(variable == "freefood", code == 1)

v %>% 
  ggplot(aes(date_end, pct)) +
  geom_line() +
  geom_point() +
  scale_x_date(
    breaks = v$date_end,
    minor_breaks = NULL,
    date_labels = "%b %e"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(1),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  labs(
    title = 
      "During the last 7 days, did you or anyone in\nyour household get free groceries or a free meal?",
    x = "Survey end date",
    y = "Percentage of adults in households that received free food",
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

<br>
<br>

```{r fig.asp=0.8}
v <- 
  hps %>% 
  filter(str_detect(variable, "^wherefree"), code == 1) %>% 
  mutate(response = str_wrap(response, width = 50))

v %>% 
  ggplot(aes(date_end, pct, color = fct_reorder2(response, date_end, pct))) +
  geom_line() +
  geom_point() +
  scale_x_date(
    breaks = v$date_end %>% unique() %>% sort(),
    minor_breaks = NULL,
    date_labels = "%b %e"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(10),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  guides(color = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom") +
  labs(
    title = "Where did you get free groceries or free meals?",
    x = "Survey end date",
    y = 
      "Percentage who received free food from this source",
    color = NULL,
    caption = "Source: Census Bureau, Household Pulse Survey."
  )
```

Since respondents can choose more than one source of free groceries or free meals, they sum to greater than 100%.
<br>
<br>

## Unemployment

### Rate over time

```{r}
v <- 
  unemployment %>% 
  filter(area_type == "State") %>% 
  arrange(date)
  
v %>% 
  filter(area_type == "State") %>% 
  ggplot(aes(date, unemployment_rate)) +
  geom_line() +
  geom_point() +
  scale_x_date(
    breaks = v$date,
    minor_breaks = NULL,
    date_labels = "%b"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(2),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  labs(
    title = "Unemployment rate",
    x = NULL,
    y = "Unemployment rate",
    caption = 
      "Source: Bureau of Labor Statistics, Local Area Unemployment Statitics."
  )
```

The data for the most recent month is typically "preliminary" and subject to revision when the following month's data is released.

### Geography

The map below is for `r month(max(v$date))`. Hover over counties for rates.

```{r}
v <- 
  left_join(
    county_boundaries,
    unemployment %>% 
      filter(area_type == "County", date == max(date)) %>% 
      left_join(population %>% select(fips, population_18p), by = "fips"),
    by = c("GEOID" = "fips")
  )

v %>% 
  choropleth(
    var = unemployment_rate,
    population = population_18p,
    tooltip = 
      "<strong>{area}</strong><br/>Unemployment rate: {format(unemployment_rate, trim = TRUE, nsmall = 1)}%",
    legend_title = "Unemployment rate"
  )
```

Source: Bureau of Labor Statistics, Local Area Unemployment Statistics.
