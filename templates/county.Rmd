---
title: ""
params:
  area: ""
date: "`r Sys.Date()`"
output:
  blogdown::html_page:
    toc: true
---

```{r setup, include=FALSE, out.width="100%"}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(reactable)

# Parameters
  # Household Pulse data for state
file_hps <- here::here("data/state.csv")
  # Unemployment data
file_unemployment <- here::here("data/unemployment.csv")
  # Food insufficiency estimates for counties
file_counties <- here::here("data/counties.csv")

#===============================================================================

# Household Pulse data for state
hps <- 
  read_csv(file_hps) %>% 
  filter(area_type == "State", variable == "curfoodsuf", code %in% 3:4)
# Unemployment data
unemployment <- 
  read_csv(file_unemployment) %>% 
  filter(area_type == "State" | area == params$area)
# State
state <- 
  unemployment %>% 
  filter(area_type == "State") %>% 
  distinct(area) %>% 
  pull(area)
# Food insufficiency estimates for county
county <- 
  read_csv(file_counties) %>% 
  filter(area == params$area)
```

## Food insufficiency

```{r}
v <- 
  bind_rows(
    county %>% 
      group_by(area, date_end, variable) %>% 
      summarize(
        n = sum(n),
        pct = sum(pct)
      ) %>% 
      ungroup(),
    hps %>% 
      group_by(area, date_end, variable) %>% 
      summarize(
        n = sum(n),
        pct = sum(pct)
      ) %>% 
      ungroup()
  ) %>% 
  mutate(area = factor(area, levels = c(params$area, state)))

v %>% 
  ggplot(aes(date_end, pct, color = area)) +
  geom_line() +
  geom_point() +
  scale_x_date(
    breaks = v$date_end,
    minor_breaks = NULL,
    date_labels = "%b %e"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(1),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  theme(legend.position = "bottom") +
  labs(
    title = "Food insufficiency during the prior 7 days",
    x = "Survey end date",
    y = "Percentage of adults in households with insufficient food",
    color = NULL,
    caption = 
      "Estimated from: Census Bureau, Household Pulse Survey.\nBureau of Labor Statistics, Local Area Unemployment Statistics."
  )
```

<br>

```{r}
v %>% 
  filter(area == params$area) %>% 
  select(date_end, n, pct) %>% 
  mutate(
    n = signif(n, digits = 3),
    pct = round(pct, digits = 1)
  ) %>% 
  arrange(desc(date_end)) %>% 
  rename(
    "Survey end date" = date_end, 
    "Adults reporting food insufficiency" = n,
    "Percentage of adults reporting food insufficiency" = pct
  ) %>% 
  reactable(
    showSortable = TRUE,
    defaultColDef = colDef(align = "left"),
    columns = 
      list(
        "Adults reporting food insufficiency" = colDef(format = colFormat(separators = TRUE)),
        "Percentage of adults reporting food insufficiency" = 
          colDef(format = colFormat(suffix = "%"))
      )
  )

v <- 
  v %>% 
  filter(area == params$area, date_end == max(date_end))
```

In the most recent survey period that ended `r format(v$date_end, "%B %e")`, an estimated `r format(round(v$pct, digits = 1))`% of `r params$area` adults, or approximately `r format(signif(v$n, digits = 3), big.mark = ",")` adults, lived in households with food insufficiency.

These food insufficiency estimates are based upon a model. The model uses the food insufficiency rate for the entire state and the county unemployment rates to estimate food insufficiency for each county. State-level food insufficiency data is released every week, and county-level unemployment data is release every month. For months where unemployment data is not yet available, the model uses the latest month for which data is available. We will revise the county-level food insufficiency estimates for such months in later reports as new unemployment data becomes available.

## Unemployment

```{r}
unemployment %>% 
  mutate(area = factor(area, levels = c(params$area, state))) %>% 
  ggplot(aes(date, unemployment_rate, color = area)) +
  geom_line() +
  geom_point() +
  scale_x_date(
    breaks = unemployment$date,
    minor_breaks = NULL,
    date_labels = "%b"
  ) +
  scale_y_continuous(
    breaks = scales::breaks_width(2),
    labels = scales::label_percent(accuracy = 1, scale = 1),
    limits = c(0, NA)
  ) +
  theme(legend.position = "bottom") +
  labs(
    title = "Unemployment rate",
    x = NULL,
    y = "Unemployment rate",
    color = NULL,
    caption = 
      "Source: Bureau of Labor Statistics, Local Area Unemployment Statistics."
  )
```

<br>

```{r}
unemployment %>% 
  filter(area == params$area) %>% 
  arrange(desc(date)) %>% 
  mutate(
    date = format(date, "%B %Y")
  ) %>% 
  select(
    Month = date,
    "Unemployment rate" = unemployment_rate
  ) %>% 
  reactable(
    showSortable = TRUE,
    defaultColDef = colDef(align = "left"),
    columns = 
      list("Unemployment rate" = colDef(format = colFormat(suffix = "%")))
  )
```


The data for the most recent month is typically "preliminary" and subject to revision when the following month's data is released.

